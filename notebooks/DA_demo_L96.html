

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Assimilation demo in the Lorenz 96 (L96) two time-scale model &#8212; Learning Machine Learning with Lorenz-96</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DA_demo_L96';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Learning Data Assimilation Increments" href="Learning-DA-increments.html" />
    <link rel="prev" title="Adding constraints to Neural Networks" href="constraints.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/newlogo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/newlogo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">Learning Machine Learning with Lorenz-96</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Lorenz-96 and General Circulation Models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="L96-two-scale-description.html">The Lorenz-96 Two-Timescale System</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm-analogue.html">The Lorenz-96 and its GCM Analog</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm-parameterization-problem.html">GCM parameterizations, skill metrics, and other sources of uncertainity</a></li>
<li class="toctree-l1"><a class="reference internal" href="estimating-gcm-parameters.html">Tuning GCM Parameterizations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Neural Networks with Lorenz-96</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro_ML_and_NNs.html">Introduction to Machine Learning and Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="L96_offline_training_NN.html">Using Neural Networks for L96 Parameterization: Offline Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="L96_online_implement_NN.html">Using Neural Networks for L96 Parameterization: Online Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="L96_online_training_NN.html">Using Neural Networks for L96 Parameterization: Online Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="Improving_Neural_networks.html">Improving Performance of Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="Neural-Network-Interpretation.html">Interpreting Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="constraints.html">Adding constraints to Neural Networks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Assimilation with Lorenz-96</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Data Assimilation demo in the Lorenz 96 (L96) two time-scale model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Learning-DA-increments.html">Learning Data Assimilation Increments</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Equation Discovery with Lorenz-96</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="symbolic_methods_comparison.html">Introduction to Equation Discovery - Comparing Symbolic Regression Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="sindy_L96_2scale.html">Applying SINDy equation identification to L96</a></li>

<li class="toctree-l1"><a class="reference internal" href="symbolic_vs_nn_multiscale_L96.html">Symbolic Regression vs. Neural Networks on Multiscale L96</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Other ML approaches for Lorenz-96</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="random_forest_parameterization.html">Random Forest</a></li>
<li class="toctree-l1"><a class="reference internal" href="GP_lorenz96.html">Gaussian Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="local_map_L96_and_Burgers.html">CNNs and Polynomial Maps</a></li>




<li class="toctree-l1"><a class="reference internal" href="L96_ResNet_RNN.html">ResNet and Recurrent Neural Networks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">End Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="closing_remarks.html">Outlook</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing this book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/DA_demo_L96.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data Assimilation demo in the Lorenz 96 (L96) two time-scale model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-da-why-do-we-do-it">What is DA? Why do we do it?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-of-the-data-assimilation-experiments-in-l96">Design of the data assimilation experiments in L96</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-our-gcm-and-da-parameters-to-use-throughout-notebook">1. Define our “GCM” and DA parameters to use throughout notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-truth-run-from-two-time-scale-l96-model">2. Generate <code class="docutils literal notranslate"><span class="pre">truth</span></code> run from two time-scale L96 model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-synthetic-observations">3. Generate synthetic observations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-model-background-covariances-for-the-variable-x">Check the Model Background Covariances for the variable <code class="docutils literal notranslate"><span class="pre">X</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-data-assimilation">4. Run Data Assimilation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-processing-and-visualization">5. Post Processing and Visualization</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="data-assimilation-demo-in-the-lorenz-96-l96-two-time-scale-model">
<h1>Data Assimilation demo in the Lorenz 96 (L96) two time-scale model<a class="headerlink" href="#data-assimilation-demo-in-the-lorenz-96-l96-two-time-scale-model" title="Permalink to this headline">#</a></h1>
<div class="section" id="what-is-da-why-do-we-do-it">
<h2>What is DA? Why do we do it?<a class="headerlink" href="#what-is-da-why-do-we-do-it" title="Permalink to this headline">#</a></h2>
<p>Data assimilation is an approach for combining data (e.g. observations) with prior knowledge (e.g. from a physical model) to obtain an estimate of the true state of a system. We use data assimilation to generate accurate initial conditions for weather and climate predictions, and to produce reanalysis products (state estimates) of the atmosphere-ocean-sea ice-land system.</p>
<p>Conceptually, data assimilation follows the Bayes’ Rule:</p>
<div class="amsmath math notranslate nohighlight" id="equation-1a1c3f5e-74da-426c-9903-41ea1102b497">
<span class="eqno">(18)<a class="headerlink" href="#equation-1a1c3f5e-74da-426c-9903-41ea1102b497" title="Permalink to this equation">#</a></span>\[\begin{align}
\ P(X|Obs)=\frac{P(Obs|X)P(X)}{P(Obs)}
\end{align}\]</div>
<p>where <span class="math notranslate nohighlight">\(X\)</span> is the state of the dynamic system, <span class="math notranslate nohighlight">\(P(X|Obs)\)</span> is the posterior distribution, or the analysis in DA terms, and <span class="math notranslate nohighlight">\(P(X)\)</span> is the prior distribution, or the forecast in DA terms. <span class="math notranslate nohighlight">\(P(Obs|X)\)</span> is the observation distribution given the prior. Simply speaking, we want to know the best estimate of the current state <span class="math notranslate nohighlight">\(X\)</span> of the system given the available observations. Below is a simple schematic representation of one DA step.</p>
<div class="figure align-default">
<img alt="../_images/DA_step.png" src="../_images/DA_step.png" />
</div>
</div>
<div class="section" id="design-of-the-data-assimilation-experiments-in-l96">
<h2>Design of the data assimilation experiments in L96<a class="headerlink" href="#design-of-the-data-assimilation-experiments-in-l96" title="Permalink to this headline">#</a></h2>
<p>We use the 2-scale Lorenz-96 model as our truth, or our representation of the “real world”. We then use the 1-scale L96 model as our DA model, or our representation of the “GCM”. Detailed description of this setup can be find here (https://m2lines.github.io/L96_demo/notebooks/gcm-analogue.html). This is what we call an idealized biased-model framework in DA research, in the sense that our DA model is biased compared to the truth, similar to real-world situations where our GCMs are biased against the natural weather or climate systems.</p>
<p>We will follow the follwing steps when doing DA in this idealized biased L96 framework:</p>
<ol class="arabic simple">
<li><p>Specify a biased “GCM” model for performing DA, and set the parameters for the “GCM”, observations, and DA method in <code class="docutils literal notranslate"><span class="pre">Config</span></code>.</p>
<ul class="simple">
<li><p>Parameters to experiment in <code class="docutils literal notranslate"><span class="pre">Config</span></code>: forcing <code class="docutils literal notranslate"><span class="pre">F</span></code>, seasonal cycle, experiment length,</p></li>
</ul>
</li>
<li><p>Generate a “truth” signal from the 2-scale L96 model</p></li>
<li><p>Collect sparse and noisy observations, sampled from “truth”</p>
<ul class="simple">
<li><p>Parameters to experiment in <code class="docutils literal notranslate"><span class="pre">Config</span></code>: observation density in space, frequency in time, observational error</p></li>
</ul>
</li>
<li><p>Perform DA using a method of choice</p>
<ul class="simple">
<li><p>Parameters to experiment in <code class="docutils literal notranslate"><span class="pre">Config</span></code>: DA method (EnKF, 3DVAR, Hybrid EnKF), DA frequency, ensemble size (for EnKF), localization, inflation method and factor</p></li>
<li><p>Optional: parameter estimation to recover the true forcing</p></li>
</ul>
</li>
<li><p>Assess DA performance</p>
<ul class="simple">
<li><p>RMSE of DA experiment relative to truth</p></li>
</ul>
</li>
<li><p>Analyze DA increments to assess GCM model error (optional)</p></li>
</ol>
<div class="section" id="define-our-gcm-and-da-parameters-to-use-throughout-notebook">
<h3>1. Define our “GCM” and DA parameters to use throughout notebook<a class="headerlink" href="#define-our-gcm-and-da-parameters-to-use-throughout-notebook" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">L96_model</span> <span class="kn">import</span> <span class="n">L96</span><span class="p">,</span> <span class="n">RK4</span><span class="p">,</span> <span class="n">L96_2t_xdot_ydot</span><span class="p">,</span> <span class="n">L96_eq1_xdot</span><span class="p">,</span> <span class="n">L96s</span>
<span class="kn">import</span> <span class="nn">DA_methods</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">GCM</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A toy `General Circulation Model` (GCM) that uses the single time-scale Lorenz 1996 model</span>
<span class="sd">    with a parameterised coupling term to represent the interaction between the observed coarse</span>
<span class="sd">    scale processes `X` and unobserved fine scale processes `Y` of the two time-scale model.</span>

<span class="sd">    Args:</span>
<span class="sd">        X_init: Initial conditions of X</span>
<span class="sd">        F: Forcing term</span>
<span class="sd">        dt: Sampling frequency of the model</span>
<span class="sd">        nt: Number of timesteps for which to run the model</span>
<span class="sd">        param: Weights to give to the coupling term</span>

<span class="sd">    Returns:</span>
<span class="sd">        Model output for all variables of X at each timestep along with the corresponding time units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_init</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">X_init</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">L96_eq1_xdot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>
        <span class="n">hist</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hist</span><span class="p">,</span> <span class="n">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="c1"># fmt: off</span>
    <span class="n">K</span> <span class="o">=</span> <span class="mi">40</span>                              <span class="c1"># Dimension of L96 `X` variables</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">10</span>                              <span class="c1"># Dimension of L96 `Y` variables</span>
    <span class="n">obs_freq</span> <span class="o">=</span> <span class="mi">10</span>                       <span class="c1"># Observation frequency (number of sampling intervals (si) per observation)</span>
    <span class="n">F_truth</span> <span class="o">=</span> <span class="mi">10</span>                        <span class="c1"># F for truth signal</span>
    <span class="n">F_fcst</span> <span class="o">=</span> <span class="mi">10</span>                         <span class="c1"># F for forecast (DA) model</span>
    <span class="n">GCM_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># Polynomial coefficicents for GCM parameterization</span>
    <span class="n">ns_da</span> <span class="o">=</span> <span class="mi">2000</span>                        <span class="c1"># Number of time samples for DA</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="mi">2000</span>                           <span class="c1"># Number of time samples for truth signal</span>
    <span class="n">ns_spinup</span> <span class="o">=</span> <span class="mi">200</span>                     <span class="c1"># Number of time samples for spin up</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.005</span>                          <span class="c1"># Model timestep</span>
    <span class="n">si</span> <span class="o">=</span> <span class="mf">0.005</span>                          <span class="c1"># Truth sampling interval</span>
    <span class="n">seasonal</span> <span class="o">=</span> <span class="kc">False</span>                    <span class="c1"># Option for adding a seasonal cycle to the forcing in the L96 truth model</span>
    <span class="n">B_loc</span> <span class="o">=</span> <span class="mi">5</span>                           <span class="c1"># Spatial localization radius for DA in terms of model grid points</span>
    <span class="n">DA</span> <span class="o">=</span> <span class="s2">&quot;EnKF&quot;</span>                         <span class="c1"># DA method</span>
    <span class="n">nens</span> <span class="o">=</span> <span class="mi">500</span>                          <span class="c1"># Number of ensemble members for DA</span>
    <span class="n">inflate_opt</span> <span class="o">=</span> <span class="s2">&quot;relaxation&quot;</span>          <span class="c1"># Method for DA model covariance inflation</span>
    <span class="n">inflate_factor</span> <span class="o">=</span> <span class="mf">0.65</span>                <span class="c1"># Inflation factor</span>
    <span class="n">hybrid_factor</span> <span class="o">=</span> <span class="mf">0.1</span>                 <span class="c1"># Weighting factor for hybrid EnKF method (weight of static B matrix)</span>
    <span class="n">param_DA</span> <span class="o">=</span> <span class="kc">False</span>                    <span class="c1"># Switch to turn on parameter estimation with DA</span>
    <span class="n">param_sd</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>   <span class="c1"># Polynomal parameter standard deviation</span>
    <span class="n">param_inflate</span> <span class="o">=</span> <span class="s2">&quot;multiplicative&quot;</span>    <span class="c1"># Method for parameter variance inflation</span>
    <span class="n">param_inf_factor</span> <span class="o">=</span> <span class="mf">0.02</span>             <span class="c1"># Parameter inflation factor</span>
    <span class="n">obs_density</span> <span class="o">=</span> <span class="mf">0.2</span>                   <span class="c1"># Fraction of spatial gridpoints where observations are collected</span>
    <span class="n">DA_freq</span> <span class="o">=</span> <span class="mi">10</span>                        <span class="c1"># Assimilation frequency (number of sampling intervals (si) per assimilation step)</span>
    <span class="n">obs_sigma</span> <span class="o">=</span> <span class="mf">0.5</span>                     <span class="c1"># Observational error standard deviation</span>
    <span class="n">save_fig</span> <span class="o">=</span> <span class="kc">False</span>                    <span class="c1"># Switch to save figure file</span>
    <span class="n">save_data</span> <span class="o">=</span> <span class="kc">False</span>                   <span class="c1"># Switch to save</span>
    <span class="c1"># fmt: on</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generate-truth-run-from-two-time-scale-l96-model">
<h3>2. Generate <code class="docutils literal notranslate"><span class="pre">truth</span></code> run from two time-scale L96 model<a class="headerlink" href="#generate-truth-run-from-two-time-scale-l96-model" title="Permalink to this headline">#</a></h3>
<p>We initialise the L96 two time-scale model using a set of random normally distributed values for <span class="math notranslate nohighlight">\(X\)</span>, and zeros for <span class="math notranslate nohighlight">\(Y\)</span>, and run it forward for a period <code class="docutils literal notranslate"><span class="pre">ns_spinup</span></code> to allow the model to spinup. The <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> components of the spinup are then used as initial conditions for another forward run for a time period <code class="docutils literal notranslate"><span class="pre">ns</span></code> to represent the unobserved <code class="docutils literal notranslate"><span class="pre">truth</span></code> field from which our observations will be derived.</p>
<p><em>Note that in reality we do not observe the fine scale components (<span class="math notranslate nohighlight">\(Y\)</span>s) and so this is what we aim to represent in the parameterisation in the <code class="docutils literal notranslate"><span class="pre">GCM()</span></code> function.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the &quot;truth&quot; 2-scale L96 model</span>
<span class="n">M_truth</span> <span class="o">=</span> <span class="n">L96</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="n">F</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">F_truth</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Generate the initial conditions of <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M_truth</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">)),</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">j</span><span class="p">)</span>

<span class="c1"># The model runs for `ns_spinup` timesteps to spin-up</span>
<span class="n">X_spinup</span><span class="p">,</span> <span class="n">Y_spinup</span><span class="p">,</span> <span class="n">t_spinup</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">ns_spinup</span><span class="p">)</span>

<span class="c1"># The initial conditions for the first forecast (prior to DA)</span>
<span class="c1"># are the last time sample after spinup</span>
<span class="n">X_init</span> <span class="o">=</span> <span class="n">X_spinup</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">Y_init</span> <span class="o">=</span> <span class="n">Y_spinup</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Using the generated initial conditions above, run <strong>L96</strong> to generate the <code class="docutils literal notranslate"><span class="pre">truth</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M_truth</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">Y_init</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>L96: K=40 J=10 F=10 h=1 b=10 c=10 dt=0.005
</pre></div>
</div>
</div>
</div>
<p>If given in <code class="docutils literal notranslate"><span class="pre">Config</span></code>, give <code class="docutils literal notranslate"><span class="pre">F</span></code> a <strong>seasonal cycle</strong> in the truth model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">seasonal</span><span class="p">:</span>
    <span class="n">ann_period</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">mon_period</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">mon_per_ann</span> <span class="o">=</span> <span class="n">ann_period</span> <span class="o">/</span> <span class="n">mon_period</span>
    <span class="n">X_truth</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">,</span> <span class="n">t_truth</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span> <span class="o">*</span> <span class="n">mon_period</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns</span> <span class="o">/</span> <span class="n">mon_period</span><span class="p">)):</span>
        <span class="n">M_truth</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">X_truth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Y_truth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="n">M_truth</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">F_truth</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">mon_per_ann</span><span class="p">))</span>
        <span class="n">X_step</span><span class="p">,</span> <span class="n">Y_step</span><span class="p">,</span> <span class="n">t_step</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span> <span class="o">*</span> <span class="n">mon_period</span><span class="p">)</span>
        <span class="n">X_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_truth</span><span class="p">,</span> <span class="n">X_step</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span>
        <span class="n">Y_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y_truth</span><span class="p">,</span> <span class="n">Y_step</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span>
        <span class="n">t_truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">t_truth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t_step</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">]))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">X_truth</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">,</span> <span class="n">t_truth</span> <span class="o">=</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we generate climatological background (temporal) covariance <code class="docutils literal notranslate"><span class="pre">B_clim2</span></code> for the 2-scale L96 model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_clim2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_truth</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting values of <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>

<span class="c1"># Snapshot of X[k]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">j</span> <span class="o">/</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$X,Y$ @ $t=N\Delta t$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;k:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">j</span> <span class="o">/</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;k:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>

<span class="c1"># Sample time-series X[0](t), Y[0](t)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_truth</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$X[0,t]$, $Y[0,t]$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>

<span class="c1"># Full model history of X</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">t_truth</span><span class="p">,</span> <span class="n">X_truth</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$X(k,t)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>

<span class="c1"># Full model history of Y</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">j</span> <span class="o">/</span> <span class="n">M_truth</span><span class="o">.</span><span class="n">J</span><span class="p">,</span> <span class="n">t_truth</span><span class="p">,</span> <span class="n">Y_truth</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$Y(k,t)$&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/825e08824393809514e7fd0e0700b40ab0459951dacaaf619dee2480917dd6d4.png" src="../_images/825e08824393809514e7fd0e0700b40ab0459951dacaaf619dee2480917dd6d4.png" />
</div>
</div>
<p>Generating climatological background covariance <code class="docutils literal notranslate"><span class="pre">B_clim1</span></code> for 1-scale L96 model. This climatological covariance will be used by the 3-dimensional variational (3DVar) DA method, or by the hybrid 3DVar-EnKF method. Since we cannot observe every state variable at every possible location, when assimilting sparse observations into the model, we need to use each observation to update multiple model locations, usually around the observed location. The covariance are thus needed to project the model-observation misfits between different model locations in certain DA methods such as 3DVar and EnKF.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M_1s</span> <span class="o">=</span> <span class="n">L96s</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">F</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">F_truth</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RK4</span><span class="p">)</span>
<span class="n">M_1s</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">X_init</span><span class="p">)</span>
<span class="n">X1_truth</span><span class="p">,</span> <span class="n">t1_truth</span> <span class="o">=</span> <span class="n">M_1s</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
<span class="n">B_clim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X1_truth</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generate-synthetic-observations">
<h3>3. Generate synthetic observations<a class="headerlink" href="#generate-synthetic-observations" title="Permalink to this headline">#</a></h3>
<p>Here we generate a set of sparse observations by sampling from the <code class="docutils literal notranslate"><span class="pre">X_truth</span></code> run and adding some random Gaussian noise. The observations are stored as individual samples, each containing the time, location, and value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample the &quot;truth&quot; to generate observations at certain times (t_obs) and locations (l_obs)</span>
<span class="n">t_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_freq</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_freq</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_freq</span><span class="p">),</span>
    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_density</span><span class="p">),</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">l_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">l_obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_density</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

<span class="n">X_obs</span> <span class="o">=</span> <span class="n">X_truth</span><span class="p">[</span><span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">]</span> <span class="o">+</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_sigma</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">l_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The covariance matrix <code class="docutils literal notranslate"><span class="pre">R</span></code> for the observations (used to express the uncertainty in the observations during DA) is given as a diagonal matrix with entries defined by the square of the “observational error standard deviation”. <span class="math notranslate nohighlight">\(R\)</span> is a diagonal matrix because we assume that the errors of different observations are independent. The function <code class="docutils literal notranslate"><span class="pre">find_obs</span></code> is used here to find the locations and values of a set of observations given the observed times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculated observation covariance matrix, assuming independent observations</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">obs_density</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">),</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;truth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">t_obs</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">DA_methods</span><span class="o">.</span><span class="n">find_obs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="p">[</span><span class="n">t_obs</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">t_obs</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9e0dfb2849bf3e77ba2e2a3ef0766eddcc933ff11cf8f52f96d038a687f597ce.png" src="../_images/9e0dfb2849bf3e77ba2e2a3ef0766eddcc933ff11cf8f52f96d038a687f597ce.png" />
</div>
</div>
<div class="section" id="check-the-model-background-covariances-for-the-variable-x">
<h4>Check the Model Background Covariances for the variable <code class="docutils literal notranslate"><span class="pre">X</span></code><a class="headerlink" href="#check-the-model-background-covariances-for-the-variable-x" title="Permalink to this headline">#</a></h4>
<p>The climatological covariances of both the “truth” (2-scale L96) and “GCM” (1-scale L96) are computed a-priori from a long run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_corr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">B_corr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">B_clim2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B_clim1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">B_corr1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_clim1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B_clim1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_clim1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">B_corr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_clim2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B_clim2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">B_clim2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">B_corr1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Background correlation matrix: 1-scale L96&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">B_corr2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Background correlation matrix: 2-scale L96&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4ebd6cf8698ab3893c237f8c154c263fb66a9cc25b2c135bf9355de64000eab8.png" src="../_images/4ebd6cf8698ab3893c237f8c154c263fb66a9cc25b2c135bf9355de64000eab8.png" />
</div>
</div>
</div>
</div>
<div class="section" id="run-data-assimilation">
<h3>4. Run Data Assimilation<a class="headerlink" href="#run-data-assimilation" title="Permalink to this headline">#</a></h3>
<p>During each DA cycle, we produce an updated state estimate for all <span class="math notranslate nohighlight">\(K\)</span> grid points, and all <code class="docutils literal notranslate"><span class="pre">n</span></code> number of ensemble members.</p>
<p>The inputs are:</p>
<ul class="simple">
<li><p>prior estimate (the forecast at time t for all K grid points, and all n number of ensemble members)</p></li>
<li><p>observations (N observations)</p></li>
<li><p>operator matrix (N x K)</p></li>
<li><p>covariance over obs (N x N)</p></li>
<li><p>covariance over model (K x K)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Set up array to store DA increments</span>
<span class="n">X_inc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">),</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="p">))</span>
<span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;3DVar&quot;</span><span class="p">:</span>
    <span class="n">X_inc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X_inc</span><span class="p">)</span>

<span class="n">t_DA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize ensemble with perturbations</span>
<span class="n">i_t</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ensX</span> <span class="o">=</span> <span class="n">X_init</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="p">))</span>
<span class="n">X_post</span> <span class="o">=</span> <span class="n">ensX</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Localize the covariance matrix in advance to avoid the calculation at each DA step</span>
<span class="c1"># The localization weight matrix is also saved for EnKF</span>

<span class="n">B_loc</span><span class="p">,</span> <span class="n">W_clim</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">localize_covariance</span><span class="p">(</span><span class="n">B_clim1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">B_loc</span><span class="p">)</span>

<span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_DA</span><span class="p">:</span>
    <span class="n">mean_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)))</span>
    <span class="n">spread_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)))</span>
    <span class="n">param_scale</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_sd</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">),</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)))</span>
    <span class="n">W</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_clim</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">W_clim</span>
    <span class="n">param_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ens_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">),</span> <span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)):</span>
    <span class="n">ens_param</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">param_scale</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">nens</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Set up array to store model forecast for each DA cycle</span>
    <span class="n">ensX_fcst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="p">))</span>

    <span class="c1"># Model forecast for next DA cycle</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="p">):</span>
        <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">GCM</span><span class="p">(</span>
            <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">F_fcst</span><span class="p">,</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">,</span>
            <span class="n">ens_param</span><span class="p">[:,</span> <span class="n">n</span><span class="p">],</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">i_t</span> <span class="o">=</span> <span class="n">i_t</span> <span class="o">+</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span>

    <span class="c1"># Get prior/background from the forecast</span>
    <span class="n">X_prior</span> <span class="o">=</span> <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="c1"># Call DA</span>
    <span class="n">t_DA</span><span class="p">[</span><span class="n">cycle</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_truth</span><span class="p">[</span><span class="n">i_t</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;EnKF&quot;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">observation_operator</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">i_t</span><span class="p">)</span>

        <span class="c1"># Augment state vector with parameters when doing parameter estimation</span>
        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_DA</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)))),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">X_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_prior</span><span class="p">,</span> <span class="n">ens_param</span><span class="p">))</span>
        <span class="n">B_ens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_prior</span><span class="p">)</span>
        <span class="n">B_ens_loc</span> <span class="o">=</span> <span class="n">B_ens</span> <span class="o">*</span> <span class="n">W</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">EnKF</span><span class="p">(</span><span class="n">X_prior</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">B_ens_loc</span><span class="p">)</span>

        <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">ens_inflate</span><span class="p">(</span>
            <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">X_prior</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="p">:],</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">inflate_opt</span><span class="p">,</span>
            <span class="n">Config</span><span class="o">.</span><span class="n">inflate_factor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_DA</span><span class="p">:</span>
            <span class="n">X_post</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">ens_inflate</span><span class="p">(</span>
                <span class="n">X_post</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">X_prior</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)</span> <span class="p">:,</span> <span class="p">:],</span>
                <span class="n">Config</span><span class="o">.</span><span class="n">param_inflate</span><span class="p">,</span>
                <span class="n">Config</span><span class="o">.</span><span class="n">param_inf_factor</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ens_param</span> <span class="o">=</span> <span class="n">X_post</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">)</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">elif</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;HyEnKF&quot;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">observation_operator</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">i_t</span><span class="p">)</span>
        <span class="n">B_ens</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_prior</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Config</span><span class="o">.</span><span class="n">hybrid_factor</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">B_clim1</span> <span class="o">*</span> <span class="n">Config</span><span class="o">.</span><span class="n">hybrid_factor</span>
        <span class="p">)</span>
        <span class="n">B_ens_loc</span> <span class="o">=</span> <span class="n">B_ens</span> <span class="o">*</span> <span class="n">W</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">EnKF</span><span class="p">(</span><span class="n">X_prior</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">B_ens_loc</span><span class="p">)</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">ens_inflate</span><span class="p">(</span>
            <span class="n">X_post</span><span class="p">,</span> <span class="n">X_prior</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">inflate_opt</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">inflate_factor</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;3DVar&quot;</span><span class="p">:</span>
        <span class="n">X_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X_prior</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">observation_operator</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">i_t</span><span class="p">)</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">DA_methods</span><span class="o">.</span><span class="n">Lin3dvar</span><span class="p">(</span><span class="n">X_prior</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">B_loc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;Replace&quot;</span><span class="p">:</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">X_prior</span>
        <span class="n">X_post</span><span class="p">[</span><span class="n">l_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">]]</span> <span class="o">=</span> <span class="n">X_obs</span><span class="p">[</span><span class="n">t_obs</span> <span class="o">==</span> <span class="n">i_t</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">X_post</span> <span class="o">=</span> <span class="n">X_prior</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="c1"># Get current increments</span>
        <span class="n">X_inc</span><span class="p">[</span><span class="n">cycle</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-</span> <span class="n">X_prior</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Get posterior info about the estimated parameters</span>
        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_DA</span><span class="p">:</span>
            <span class="n">mean_param</span><span class="p">[</span><span class="n">cycle</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ens_param</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">spread_param</span><span class="p">[</span><span class="n">cycle</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ens_param</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reset initial conditions for next DA cycle</span>
    <span class="n">ensX_fcst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X_post</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ensX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ensX</span><span class="p">,</span> <span class="n">ensX_fcst</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time to complete DA: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (s)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time to complete DA: 35.82 (s)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="post-processing-and-visualization">
<h3>5. Post Processing and Visualization<a class="headerlink" href="#post-processing-and-visualization" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_X</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">mean_X</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=-</span><span class="n">clim</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span>
    <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;neither&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X - X_truth&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">mean_X</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spread&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">Config</span><span class="o">.</span><span class="n">obs_sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Obs error&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RMSE (X - X_truth)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">mean_X</span> <span class="o">-</span> <span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_inc_ave</span> <span class="o">=</span> <span class="n">X_inc</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inc&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">DA_methods</span><span class="o">.</span><span class="n">running_average</span><span class="p">(</span><span class="n">X_inc_ave</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inc Ave&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">F_fcst</span> <span class="o">-</span> <span class="n">Config</span><span class="o">.</span><span class="n">F_truth</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;F_bias&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M_truth</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X_inc</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
    <span class="s2">&quot;k:&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ave Inc&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Increments&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="n">plot_start</span><span class="p">,</span> <span class="n">plot_end</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span>
<span class="n">plot_start_DA</span><span class="p">,</span> <span class="n">plot_end_DA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">plot_start</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
    <span class="n">plot_end</span> <span class="o">/</span> <span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span>
<span class="p">)</span>
<span class="n">plot_x</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">],</span> <span class="n">X_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">,</span> <span class="n">plot_x</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;truth&quot;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_truth</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">],</span> <span class="n">mean_X</span><span class="p">[</span><span class="n">plot_start</span><span class="p">:</span><span class="n">plot_end</span><span class="p">,</span> <span class="n">plot_x</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;forecast&quot;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">t_DA</span><span class="p">[</span><span class="n">plot_start_DA</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">plot_end_DA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">DA_methods</span><span class="o">.</span><span class="n">find_obs</span><span class="p">(</span><span class="n">plot_x</span><span class="p">,</span> <span class="n">X_obs</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">l_obs</span><span class="p">,</span> <span class="p">[</span><span class="n">plot_start</span><span class="p">,</span> <span class="n">plot_end</span><span class="p">]),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;k=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">plot_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; truth and forecast&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">param_DA</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">]):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_DA</span><span class="p">,</span>
            <span class="n">DA_methods</span><span class="o">.</span><span class="n">running_average</span><span class="p">(</span><span class="n">mean_param</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;C</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean_param</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_DA</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_DA</span><span class="p">,</span>
            <span class="n">DA_methods</span><span class="o">.</span><span class="n">running_average</span><span class="p">(</span>
                <span class="n">mean_param</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">spread_param</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">100</span>
            <span class="p">),</span>
            <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SD </span><span class="si">{</span><span class="n">spread_param</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_DA</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">):,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_DA</span><span class="p">,</span>
            <span class="n">DA_methods</span><span class="o">.</span><span class="n">running_average</span><span class="p">(</span>
                <span class="n">mean_param</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spread_param</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">100</span>
            <span class="p">),</span>
            <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="mf">0.1</span><span class="p">,</span>
    <span class="mf">0.2</span><span class="p">,</span>
    <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;RMSE=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">mean_X</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">:])</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="si">:</span><span class="s2">3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Spread=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ensX</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="si">:</span><span class="s2">3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;GCM param=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">GCM_param</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;DA=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">DA</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;DA_freq=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;B_loc=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">B_loc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;inflation=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">inflate_opt</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">inflate_factor</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_density=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_density</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_sigma=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_sigma</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_freq=</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_freq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">),</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">save_fig</span><span class="p">:</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;DA_data&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">exp_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;config_</span><span class="si">{</span><span class="n">exp_number</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">output_dir</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)})</span>
        <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fig_</span><span class="si">{</span><span class="n">exp_number</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/98f82eaf26df6c5f26480d65b600f9241ae0834358fd7812fcc3abaade294187.png" src="../_images/98f82eaf26df6c5f26480d65b600f9241ae0834358fd7812fcc3abaade294187.png" />
</div>
</div>
<p>Save DA output for further analysis</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">save_data</span><span class="p">:</span>
    <span class="n">output_filename</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;K_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">K</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;J_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">J</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_freq_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_freq</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;F_truth_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">F_truth</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;F_fcst_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">F_fcst</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ns_da_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_da</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ns_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ns_spinup_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">ns_spinup</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;dt_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;si_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">si</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;B_loc_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">B_loc</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;DA_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">DA</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;nens_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">nens</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;inflate_opt_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">inflate_opt</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;inflate_factor_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">inflate_factor</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;hybrid_factor_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">hybrid_factor</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_density_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_density</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;DA_freq_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">DA_freq</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;obs_sigma_</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">obs_sigma</span><span class="si">}</span><span class="s2">.npz&quot;</span>
    <span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;DA_data&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">),</span>
        <span class="n">mean_X</span><span class="o">=</span><span class="n">mean_X</span><span class="p">,</span>
        <span class="n">X_truth</span><span class="o">=</span><span class="n">X_truth</span><span class="p">,</span>
        <span class="n">X_inc_ave</span><span class="o">=</span><span class="n">X_inc_ave</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="constraints.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Adding constraints to Neural Networks</p>
      </div>
    </a>
    <a class="right-next"
       href="Learning-DA-increments.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Learning Data Assimilation Increments</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-da-why-do-we-do-it">What is DA? Why do we do it?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-of-the-data-assimilation-experiments-in-l96">Design of the data assimilation experiments in L96</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-our-gcm-and-da-parameters-to-use-throughout-notebook">1. Define our “GCM” and DA parameters to use throughout notebook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-truth-run-from-two-time-scale-l96-model">2. Generate <code class="docutils literal notranslate"><span class="pre">truth</span></code> run from two time-scale L96 model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-synthetic-observations">3. Generate synthetic observations</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-the-model-background-covariances-for-the-variable-x">Check the Model Background Covariances for the variable <code class="docutils literal notranslate"><span class="pre">X</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-data-assimilation">4. Run Data Assimilation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-processing-and-visualization">5. Post Processing and Visualization</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The M<sup>2</sup>LInES Community
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024 Dhruv Balwada, Ryan Abernathey, Shantanu Acharya, et al. — License: MIT for code, CC-BY for text and figures.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>